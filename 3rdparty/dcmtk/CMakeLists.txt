FetchContent_Declare(
    dcmtk
    GIT_REPOSITORY https://github.com/DCMTK/dcmtk
    GIT_TAG        DCMTK-3.6.5
)

if(ECVL_WITH_DICOM)
    if(ECVL_BUILD_DEPS)
        if(POLICY CMP0115)
            set(CMAKE_POLICY_DEFAULT_CMP0115 OLD)
        endif()
        FetchContent_GetProperties(dcmtk)
        if(NOT dcmtk_POPULATED)
            FetchContent_Populate(dcmtk)

            set(DCMTK_LIBRARIES ofstd;oflog;dcmdata;dcmimgle;dcmimage;dcmjpeg)
            
            if(ECVL_SHARED)
                SET(BUILD_SINGLE_SHARED_LIBRARY OFF CACHE INTERNAL "" FORCE)
                SET(BUILD_SHARED_LIBS ON CACHE INTERNAL "" FORCE)
            else()
                SET(BUILD_SINGLE_SHARED_LIBRARY OFF CACHE INTERNAL "" FORCE)
                SET(BUILD_SHARED_LIBS OFF CACHE INTERNAL "" FORCE)
            endif()
            SET(BUILD_APPS OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_BUILTIN_DICTIONARY ON CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_CHARSET_CONVERSION <disabled> CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_CXX11 INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_EXTERNAL_DICTIONARY ON CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_LFS lfs CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_MANPAGES OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_PRIVATE_TAGS OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_ALGORITHM INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_LIMITS INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_LIST INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_MAP INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_MEMORY INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_STACK INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_STRING INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_SYSTEM_ERROR INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_TUPLE INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_TYPE_TRAITS INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_ENABLE_STL_VECTOR INFERRED CACHE INTERNAL "" FORCE)
            SET(DCMTK_GENERATE_DOXYGEN_TAGFILE OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_MODULES ${DCMTK_LIBRARIES} CACHE INTERNAL "" FORCE)
            SET(DCMTK_OVERWRITE_WIN32_COMPILER_FLAGS ON CACHE INTERNAL "" FORCE)
            SET(DCMTK_WIDE_CHAR_FILE_IO_FUNCTIONS OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WIDE_CHAR_MAIN_FUNCTION OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_DOXYGEN OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_ICONV OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_ICU OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_OPENJPEG OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_OPENSSL OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_PNG OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_SNDFILE OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_STDLIBC_ICONV OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_THREADS ON CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_TIFF OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_XML OFF CACHE INTERNAL "" FORCE)
            SET(DCMTK_WITH_ZLIB OFF CACHE INTERNAL "" FORCE)
            SET(DOXYGEN_DOT_EXECUTABLE DOXYGEN_DOT_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(DOXYGEN_EXECUTABLE DOXYGEN_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_DATA_LIBRARY_DEBUG ICU_DATA_LIBRARY_DEBUG-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_DATA_LIBRARY_RELEASE ICU_DATA_LIBRARY_RELEASE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_DERB_EXECUTABLE ICU_DERB_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENBRK_EXECUTABLE ICU_GENBRK_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENCCODE_EXECUTABLE ICU_GENCCODE_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENCFU_EXECUTABLE ICU_GENCFU_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENCMN_EXECUTABLE ICU_GENCMN_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENCNVAL_EXECUTABLE ICU_GENCNVAL_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENDICT_EXECUTABLE ICU_GENDICT_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENNORM2_EXECUTABLE ICU_GENNORM2_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENRB_EXECUTABLE ICU_GENRB_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_GENSPREP_EXECUTABLE ICU_GENSPREP_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_ICU-CONFIG_EXECUTABLE ICU_ICU-CONFIG_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_ICUINFO_EXECUTABLE ICU_ICUINFO_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_ICUPKG_EXECUTABLE ICU_ICUPKG_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_INCLUDE_DIR ICU_INCLUDE_DIR-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_MAKECONV_EXECUTABLE ICU_MAKECONV_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_MAKEFILE_INC ICU_MAKEFILE_INC-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_PKGDATA_EXECUTABLE ICU_PKGDATA_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_PKGDATA_INC ICU_PKGDATA_INC-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_UCONV_EXECUTABLE ICU_UCONV_EXECUTABLE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_UC_LIBRARY_DEBUG ICU_UC_LIBRARY_DEBUG-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(ICU_UC_LIBRARY_RELEASE ICU_UC_LIBRARY_RELEASE-NOTFOUND CACHE INTERNAL "" FORCE)
            SET(WITH_LIBICONVINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_LIBPNGINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_LIBTIFFINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_LIBXMLINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_OPENJPEGINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_OPENSSLINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_SNDFILEINC "" CACHE INTERNAL "" FORCE)
            SET(WITH_ZLIBINC "" CACHE INTERNAL "" FORCE)
            mark_as_advanced(DCMTK_ENABLE_LFS 
                DCMTK_COMPILE_WIN32_MULTITHREADED_DLL
                BUILD_SHARED_LIBS
                BUILD_APPS
                )
            add_subdirectory(${dcmtk_SOURCE_DIR} ${dcmtk_BINARY_DIR})
        endif()
        
        foreach(DCMTK_LIB ${DCMTK_LIBRARIES})
            set_target_properties(${DCMTK_LIB} PROPERTIES DEBUG_POSTFIX d)
        endforeach()
        target_link_libraries(ECVL_CORE PUBLIC ${DCMTK_LIBRARIES})

        set(DCMTK_INCLUDE_DIRS "")
        foreach(DCMTK_LIB config ${DCMTK_LIBRARIES})
            list(APPEND DCMTK_INCLUDE_DIRS "${dcmtk_SOURCE_DIR}/${DCMTK_LIB}/include")
        endforeach()

        foreach(dcmtk_include_dir ${DCMTK_INCLUDE_DIRS})
            target_include_directories(ECVL_CORE PUBLIC $<BUILD_INTERFACE:${dcmtk_include_dir}> $<INSTALL_INTERFACE:include> )
        endforeach()
        target_include_directories(ECVL_CORE PUBLIC $<BUILD_INTERFACE:${dcmtk_BINARY_DIR}/config/include> $<INSTALL_INTERFACE:include> ) 
    else()
        find_package(DCMTK REQUIRED)
        target_include_directories(ECVL_CORE PUBLIC $<BUILD_INTERFACE:${DCMTK_INCLUDE_DIRS}> $<INSTALL_INTERFACE:include>)
        target_link_libraries(ECVL_CORE PUBLIC ${DCMTK_LIBRARIES})
    endif()
    target_sources(ECVL_CORE PRIVATE "${CMAKE_SOURCE_DIR}/modules/core/include/ecvl/core/support_dcmtk.h" "${CMAKE_SOURCE_DIR}/modules/core/src/support_dcmtk.cpp")
    message(STATUS "DCMTK libraries: ${DCMTK_LIBRARIES}")
    message(STATUS "DCMTK incldue dure: ${DCMTK_INCLUDE_DIRS}")
endif()